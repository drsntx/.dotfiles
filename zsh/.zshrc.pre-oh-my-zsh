#!/bin/zsh
# Daniel Santos' .zshrc - VERS√ÉO CORRIGIDA
# Configura√ß√£o principal do Zsh com ordem de carregamento correta

# ============================================================================
# INICIALIZA√á√ÉO B√ÅSICA (DEVE VIR PRIMEIRO)
# ============================================================================

# Set ZDOTDIR if not already set
export ZDOTDIR="${ZDOTDIR:-$HOME/.dotfiles/zsh}"

# Create zsh directory if it doesn't exist
[[ ! -d "$ZDOTDIR" ]] && mkdir -p "$ZDOTDIR"

# ============================================================================
# OH MY ZSH CONFIGURATION (ANTES DOS M√ìDULOS)
# ============================================================================

# Path to Oh My Zsh installation (CAMINHO CORRETO)
export ZSH="$HOME/.oh-my-zsh"

# Oh My Zsh theme (using Starship instead)
ZSH_THEME=""

# Oh My Zsh plugins
plugins=(
    git
    colored-man-pages
    extract
    web-search
)

# Load Oh My Zsh PRIMEIRO (se dispon√≠vel)
if [[ -f "$ZSH/oh-my-zsh.sh" ]]; then
    source "$ZSH/oh-my-zsh.sh"
else
    echo "‚ö†Ô∏è  Oh My Zsh n√£o encontrado em $ZSH"
    echo "   Execute: sh -c \"\$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)\""
fi

# ============================================================================
# INICIALIZAR COMPLETIONS (ANTES DE USAR COMPDEF)
# ============================================================================

# Initialize completions ANTES de carregar m√≥dulos
autoload -Uz compinit
compinit

# ============================================================================
# CARREGAR M√ìDULOS DOS DOTFILES (ORDEM ESPEC√çFICA)
# ============================================================================

# Fun√ß√£o para carregar m√≥dulos com verifica√ß√£o de erro
load_dotfile_module() {
    local module_file="$1"
    local module_name="$(basename "$module_file" .zsh)"
    
    if [[ -r "$module_file" ]]; then
        source "$module_file"
        # echo "‚úì Loaded: $module_name"
    else
        echo "‚ö†Ô∏è  Module not found: $module_file"
    fi
}

# Carregar m√≥dulos na ordem correta
if [[ -d "$HOME/.dotfiles/zsh/zsh.d" ]]; then
    # 1. Detec√ß√£o de OS (primeiro)
    load_dotfile_module "$HOME/.dotfiles/zsh/zsh.d/os_detection.zsh"
    
    # 2. Configura√ß√£o de paths
    load_dotfile_module "$HOME/.dotfiles/zsh/zsh.d/paths.zsh"
    
    # 3. Hist√≥rico
    load_dotfile_module "$HOME/.dotfiles/zsh/zsh.d/history.zsh"
    
    # 4. Aliases (antes das fun√ß√µes para evitar conflitos)
    load_dotfile_module "$HOME/.dotfiles/zsh/zsh.d/aliases.zsh"
    
    # 5. Fun√ß√µes (depois dos aliases)
    load_dotfile_module "$HOME/.dotfiles/zsh/zsh.d/functions.zsh"
    
    # 6. Plugins (depois de tudo estar configurado)
    load_dotfile_module "$HOME/.dotfiles/zsh/zsh.d/plugins.zsh"
    
    # 7. Inicializa√ß√£o final
    load_dotfile_module "$HOME/.dotfiles/zsh/zsh.d/init.zsh"
else
    echo "‚ö†Ô∏è  Diret√≥rio de m√≥dulos n√£o encontrado: $HOME/.dotfiles/zsh/zsh.d"
fi

# ============================================================================
# PLUGINS EXTERNOS (DEPOIS DO OH MY ZSH)
# ============================================================================

# Load external plugins manually if Oh My Zsh plugins don't work
ZSH_CUSTOM_PLUGINS="$HOME/.oh-my-zsh/custom/plugins"

# zsh-autosuggestions
if [[ -f "$ZSH_CUSTOM_PLUGINS/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
    source "$ZSH_CUSTOM_PLUGINS/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi

# zsh-syntax-highlighting (DEVE SER CARREGADO POR √öLTIMO)
if [[ -f "$ZSH_CUSTOM_PLUGINS/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
    source "$ZSH_CUSTOM_PLUGINS/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi

# zsh-history-substring-search
if [[ -f "$ZSH_CUSTOM_PLUGINS/zsh-history-substring-search/zsh-history-substring-search.zsh" ]]; then
    source "$ZSH_CUSTOM_PLUGINS/zsh-history-substring-search/zsh-history-substring-search.zsh"
    
    # Key bindings for history substring search
    bindkey '^[[A' history-substring-search-up
    bindkey '^[[B' history-substring-search-down
    bindkey -M vicmd 'k' history-substring-search-up
    bindkey -M vicmd 'j' history-substring-search-down
fi

# ============================================================================
# CONFIGURA√á√ïES FINAIS
# ============================================================================

# Load clean_history script function
[[ -f "$HOME/.dotfiles/clean_history.zsh" ]] && source "$HOME/.dotfiles/clean_history.zsh"

# FZF integration if available
[[ -f ~/.fzf.zsh ]] && source ~/.fzf.zsh

# Load local customizations if they exist (SEMPRE POR √öLTIMO)
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"

# ============================================================================
# VERIFICA√á√ÉO DE SA√öDE (OPCIONAL - REMOVER DEPOIS DE TESTAR)
# ============================================================================

# Uncomment to debug loading issues
# echo "‚úÖ .zshrc loaded successfully"
# echo "üêö Shell: $SHELL"
# echo "üìÅ ZDOTDIR: $ZDOTDIR"
# echo "‚≠ê Starship config: $STARSHIP_CONFIG"

